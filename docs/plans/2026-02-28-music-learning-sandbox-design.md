# SoundCanvas 音乐编曲学习网站 - 第一版设计文档

> 设计日期：2026-02-28  
> 状态：已确认

## 1. 目标与范围

### 1.1 目标用户

- **第一版**：零基础用户（未接触乐理、未学乐器），从节奏、和弦、旋律等基础概念入门。
- **后续**：可扩展至有一定基础、想系统学编曲的用户。

### 1.2 产品形态

- **第一版**：迷你编曲沙盒 —— 用户在学习节奏、和弦、旋律后，在网页内用「节奏轨 + 和弦轨 + 旋律轨」边学边做，产出可播放的一小段编曲。
- **第一版**：需要登录与云端保存（账号、作品列表、多设备可加载）。

### 1.3 技术方案

- **方案**：Next.js 全栈（App Router）+ Prisma + NextAuth.js + Web Audio API。
- **数据库**：开发用 SQLite，生产可用 PostgreSQL。

---

## 2. 产品模块与页面（第一版）

| 模块         | 内容                                                     | 第一版 |
|--------------|----------------------------------------------------------|--------|
| 认证         | 注册 / 登录 / 登出（邮箱 + 密码）                        | 是     |
| 首页/导航    | 站点入口、学习/沙盒入口、登录状态                        | 是     |
| 学习路径     | 节奏 → 和弦 → 旋律 的简短教程（图文 + 音频示例）         | 是     |
| 编曲沙盒     | 单页：节奏轨 + 和弦轨 + 旋律轨，播放/暂停，保存到云端   | 是     |
| 我的作品     | 作品列表（标题、创建时间）、打开/删除                    | 是     |
| 个人中心     | 昵称、改密码等                                           | 可选   |

**页面清单**

1. **首页**：简短介绍 + 入口（去学习 / 去编曲 / 登录）。
2. **学习**：节奏入门、和弦入门、旋律入门（可 3 个子页或 3 个区块，每块：概念 + 示例音频）。
3. **编曲沙盒**：单页，三条轨道 + 播放条 + 保存/另存为。
4. **我的作品**：列表，点击进入沙盒并加载该作品。
5. **登录 / 注册**：独立页或弹窗。

**第一版不做**：社区、评论、付费、复杂课程系统、多乐器/高级 MIDI。

---

## 3. 技术架构

### 3.1 技术选型

| 层级   | 选型                          | 说明                     |
|--------|-------------------------------|--------------------------|
| 框架   | Next.js 14+ (App Router)      | 单仓库、API、服务端能力  |
| 语言   | TypeScript                    | 前后端统一类型           |
| ORM/DB | Prisma + SQLite / PostgreSQL | 模型清晰、迁移简单       |
| 认证   | NextAuth.js                   | 邮箱+密码，Session       |
| 样式   | 任选（如 Tailwind CSS）       | 快速做界面               |
| 音频   | Web Audio API                 | 浏览器内发声             |

### 3.2 目录结构（建议）

```
SoundCanvas/
├── src/
│   ├── app/
│   │   ├── page.tsx              # 首页
│   │   ├── layout.tsx
│   │   ├── (auth)/login/, register/
│   │   ├── learn/rhythm/, chords/, melody/
│   │   ├── sandbox/page.tsx
│   │   ├── projects/page.tsx     # 我的作品
│   │   ├── api/auth/[...nextauth]/, api/projects/
│   │   └── ...
│   ├── components/
│   ├── lib/
│   └── ...
├── prisma/schema.prisma
├── docs/plans/
└── ...
```

### 3.3 认证与权限

- NextAuth.js Credentials Provider（邮箱 + 密码）。
- 未登录：可访问首页、学习页；不可进入沙盒保存/加载、不可访问「我的作品」。
- API：根据 Session 校验用户，作品仅允许操作本人数据。

### 3.4 数据流概要

- 登录/注册：表单 → NextAuth signIn / 注册 API → Session。
- 作品列表：我的作品页 → GET /api/projects（带 Session）→ 返回当前用户 Project 列表。
- 沙盒加载：GET /api/projects/[id] 校验归属后返回作品 JSON。
- 沙盒保存：POST（新建）/ PUT（更新）/api/projects，body 为作品 JSON，写入 DB。

---

## 4. 沙盒编辑器与数据格式

### 4.1 交互

- 单页：三条轨道（节奏、和弦、旋律）+ 统一时间轴 + 播放条。
- 时间轴：以小节为单位，第一版固定 4/4；总小节数可固定（如 8 小节）或可增。
- 播放：播放头从左到右，三轨同步播放；支持播放/暂停/停止，可循环。

### 4.2 轨道定义

| 轨道   | 含义     | 编辑方式                     | 播放方式                         |
|--------|----------|------------------------------|----------------------------------|
| 节奏轨 | 打击鼓点 | 格子点击开关，选类型         | Web Audio 采样或简单合成          |
| 和弦轨 | 和弦进行 | 每小节选一个和弦             | 按时间触发和弦（分解/柱式）      |
| 旋律轨 | 单音旋律 | 音高×时间格子或钢琴键+格子   | Web Audio 合成或采样             |

### 4.3 作品 JSON 结构（Project.content）

```json
{
  "bpm": 120,
  "timeSignature": [4, 4],
  "bars": 8,
  "rhythm": {
    "pattern": [
      { "beat": 0, "type": "kick" },
      { "beat": 2, "type": "snare" }
    ]
  },
  "chords": [
    { "barIndex": 0, "chord": "C" },
    { "barIndex": 1, "chord": "Am" },
    { "barIndex": 2, "chord": "F" },
    { "barIndex": 3, "chord": "G" }
  ],
  "melody": [
    { "barIndex": 0, "beat": 0, "note": "C4", "duration": 0.5 },
    { "barIndex": 0, "beat": 2, "note": "E4", "duration": 0.5 }
  ]
}
```

- rhythm：按 beat 索引 + 类型（如 kick、snare）。
- chords：按 barIndex + 和弦名（如 C、Am）。
- melody：按 barIndex、beat、note（如 C4）、duration（拍或比例）。

### 4.4 播放实现

- 节奏：采样或合成在对应 beat 用 AudioBufferSourceNode 触发。
- 和弦：和弦名 → 音高数组，在对应时间用 OscillatorNode + GainNode 或采样播放。
- 旋律：note + duration 在精确时间调度 Oscillator 或采样。
- 播放头：requestAnimationFrame 或 setInterval 按 BPM 推进，按时间触发各轨事件。

### 4.5 编辑器 UI 建议

- 节奏轨：一行格子（按拍），点击切换有/无及类型；左侧小节号。
- 和弦轨：按小节分格，每格选择和弦（如 C、Am、F、G 等），第一版可仅自然大调。
- 旋律轨：时间×音高网格，点击写/删音符，可选拖拽改时值。
- 三轨上下排列，共享时间轴与播放头；顶部/底部：播放控制、BPM、保存/另存为。

---

## 5. 数据库模型（核心）

- **User**：id, email, passwordHash, name, createdAt 等（与 NextAuth 约定一致）。
- **Project**：id, userId, title, createdAt, updatedAt；**content**（Text/JSON）：整首作品 JSON 字符串。

---

## 6. 错误处理与第一版边界

### 6.1 认证与 API

- 登录/注册：表单校验（邮箱格式、密码长度等）；失败返回明确错误信息，不暴露是否邮箱已存在（注册时）。
- 未登录访问需登录页：重定向到登录页或返回 401，前端提示「请先登录」。
- 作品 API：无权限（非本人作品或未登录）返回 403/401，不返回他人作品内容。

### 6.2 沙盒与作品

- 保存：校验 content 为合法 JSON、必填字段存在、数组长度/数值在合理范围（如 bars ≤ 32）；不合规返回 400 与简短错误说明。
- 加载：作品不存在或非本人返回 404/403。
- 播放：若 BPM 或数据异常，前端做默认值或跳过无效事件，避免崩溃；可静默降级不打断用户操作。

### 6.3 第一版边界

- 不实现多设备实时同步，仅「保存/加载」。
- 不实现版本历史、撤销重做（可后续迭代）。
- 学习内容第一版可为静态页面或本地 MD，不做后台 CMS。
- 错误提示以中文、简短、可操作为主；不要求国际化。

---

## 7. 后续可扩展

- 学习路径：从静态内容扩展为可配置课程或关卡。
- 沙盒：撤销/重做、更多乐器、导出音频/MIDI。
- 用户：个人中心完善、第三方登录、作品公开/分享。
- 性能：大作品分片加载、音频预加载与缓存策略。
